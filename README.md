# gofastcopy

## Summary
批量复制大量小文件的加速工具

## 原理
利用CPU多核并行特性，在内存中建立2个队列，一个队列持续从源文件夹读取小文件存入内存，一个队列不断写入文件到目标文件夹。

## 场景
从慢速机械硬盘HDD复制到快速固态硬盘SSD时，读取队列无需等待排队，写入队列极快，只要内存中有文件，即会落盘；

从SSD复制到HDD时，读取队列会提前预读文件到内存中，写入队列可以节省文件元数据的读取时间，当小文件数量到达10W以上时，这个累计时间较为客观；


## gofastcopy 性能更好
在Mac mini M4上，12，221个文件， 33698 MB，

### 同一块固态盘内复制
从SSD移动硬盘文件夹A复制到同一块SSD移动硬盘文件夹B：

```
rsync 需要 261 秒，
gofastcopy 需要 135 秒，快了 126 秒
#
# 数据：12，221个文件， 33698 MB
```

### 同一块机械硬盘内复制
从机械移动硬盘文件夹A复制到同一块机械移动硬盘文件夹B：

```
rsync 需要 1025 秒，
gofastcopy 需要 797 秒，快了 228 秒
#
# 数据：8878个文件，21147 MB
```

### 在Windows上，跨盘复制，固态到固态：

```
robocopy 需要 92 秒，
gofastcopy 需要 83 秒， 快了 9 秒
#
# 数据：46，786个文件，116.69GB，从固态A(宏碁GM7，PCIe 4.0）拷贝到固态B(SanDisk，PCIe 3.0）
```

## 性能更差

### 跨盘复制，机械到固态
在Mac mini M4上，从HDD移动机械硬盘复制到SSD移动硬盘：

```
rsync 需要 277 秒，
gofastcopy 需要 409 秒，慢了 132 秒
#
# 数据：8878个文件，21147 MB
```


## Usage
### 重新打开终端，运行
```Bash
./gofastcopy

# --debug 默认 false ： 是否显示各种调试信息
# --dry-run 默认 false ： 设置为 true 时，仅在控制台窗口显示将会复制的文件，不会实际写入文件
#
# --source-dir 默认为 空 ： 源文件夹
# --target-dir 默认为 空 ： 复制到的目标文件夹
# --exclude-dir 默认为 空 ： 如果该文件夹中存在同路径文件，该文件将被排除
# --file-ext 默认为 空 ：譬如，设置为 .mp4 ，则仅复制 mp4 文件
#
# --min-size 默认为 -1 ：文件大小【小于】该值的文件将被忽略
# --max-size 默认为 -1 ： 文件大小【大于】该值的文件将被忽略
#
# --min-size-mb 默认为 -1 ：用MB单位设置【最小】文件大小，会覆盖--min-size的值，譬如设置为16，即自动将--min-size=16*1024*1024
# --max-size-mb 默认为 -1 ：用MB单位设置【最大】文件大小，会覆盖--max-size的值，譬如设置为100，即自动将--max-size=100*1024*1024
#
# --min-age 默认为 空 ： 文件最后修改时间【早于】该值的文件将被忽略
# --max-age 默认为 空 ：文件最后修改时间【晚于】该值的文件将被忽略
#
# --ignore-dot-file 默认为 true ： 是否忽略点（.）开头的文件
# --ignore-empty-folder 默认为 true ：是否忽略空文件夹
# --overwrite 默认为 false ： 是否允许覆盖已经存在的文件
#
# --with-limit-memory 默认为 false ： 低内存模式，并行任务固定为 4.
# --with-time-utc 默认为 false ： max-age/min-age 比较时间时，默认使用本地时间，如果要使用UTC时区时间，此项设置为 true
#
# --threads 默认为 0（即自动计算）：强制指定并行线程数，默认线程数限制在32～128之间，该参数可以无限制强制指定线程数
#
# --in-single-hdd 默认为 false ： 专门针对在同一个慢速机械硬盘上A文件夹复制大量小文件到B文件夹的模式,不要在高速设备上使用该选项
#
#

